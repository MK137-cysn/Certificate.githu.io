<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxury Certificate - HD Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=Siemreap&family=Cinzel:wght@700&family=Playball&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { 
            --gold: linear-gradient(135deg, #bd9354 0%, #ffde59 50%, #bd9354 100%);
            --navy: #0c1424;
        }

        body { font-family: 'Siemreap', sans-serif; margin: 0; background: #111; color: #fff; overflow-x: hidden; }

        .navbar { 
            background: rgba(0,0,0,0.95); height: 45px; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; position: sticky; top: 0; z-index: 2000;
            border-bottom: 1px solid #bd9354;
        }
        .menu-btn { 
            background: var(--gold); border: none; padding: 5px 15px; 
            border-radius: 4px; cursor: pointer; color: #000; font-weight: bold; font-size: 12px;
        }

        /* Editor Panel */
        .overlay-editor { 
            position: fixed; top: 45px; left: 0; width: 100%; height: 0; 
            background: #fff; z-index: 1500; overflow-y: auto; transition: 0.3s;
            color: #333; padding: 0 20px; box-sizing: border-box;
        }
        .overlay-editor.active { height: calc(100% - 45px); padding-top: 20px; }
        .input-box { margin-bottom: 12px; }
        .input-box label { font-size: 11px; font-weight: bold; display: block; margin-bottom: 4px; color: var(--navy); }
        .input-box input, .input-box select, .input-box textarea { 
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; 
            font-family: 'Siemreap'; font-size: 14px; box-sizing: border-box; 
        }
        .btn-action { 
            background: var(--navy); color: gold; width: 100%; padding: 14px; 
            border: 1px solid gold; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; 
        }

        /* Certificate Styling */
        .preview-area { display: flex; flex-direction: column; align-items: center; padding: 20px; gap: 40px; }
        
        /* កែ scale ឱ្យសមស្របសម្រាប់ទូរសព្ទ */
        .cert-wrapper { transform: scale(0.3); margin: -280px 0; box-shadow: 0 20px 60px rgba(0,0,0,0.7); }
        @media (min-width: 800px) { .cert-wrapper { transform: scale(0.7); margin: -100px 0; } }

        .cert-paper { width: 1123px; height: 794px; background: var(--p); padding: 30px; box-sizing: border-box; position: relative; }
        .cert-content { 
            width: 100%; height: 100%; background: var(--bg); display: flex; 
            flex-direction: column; align-items: center; justify-content: space-between; 
            padding: 60px 80px; box-sizing: border-box; position: relative;
            border: 2px solid var(--a);
        }

        .inner-border { position: absolute; top: 12px; left: 12px; right: 12px; bottom: 12px; border: 1px solid var(--a); pointer-events: none; }
        
        .theme-navy { --p: #0c1424; --a: #d4af37; --bg: #fffdf5; }
        .theme-red { --p: #5d0000; --a: #ffde59; --bg: #fffafa; }
        .f-classic { border: 10px double var(--a); }
        
        /* ជួសជុល Line-height ដើម្បីកុំឱ្យអក្សរត្រួតគ្នា */
        .cert-title { font-family: 'Cinzel'; font-size: 90px; color: var(--p); margin: 0; line-height: 1.1; }
        .outName { font-family: 'Playball', cursive; color: var(--p); border-bottom: 4px double var(--a); padding: 0 70px; display: inline-block; margin-top: 10px; line-height: 1.2; }
        
        .footer { width: 100%; display: flex; justify-content: space-between; align-items: flex-end; margin-top: 30px; }
        .sign-block { text-align: center; width: 320px; }
        .line { border-top: 2px solid var(--p); width: 100%; margin-top: 10px; }
        
        .seal { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 120px; opacity: 0.9; }
        .deco-txt { color: var(--a); font-weight: bold; letter-spacing: 10px; font-size: 22px; font-family: 'Cinzel'; line-height: 1; }
    </style>
</head>
<body class="theme-navy">

    <div class="navbar">
        <button class="menu-btn" onclick="toggleMenu()">☰ កែអត្ថបទ</button>
        <div style="font-family: 'Cinzel'; font-size: 11px; color: gold; letter-spacing: 1px;">PREMIUM GENERATOR</div>
        <div></div>
    </div>

    <div class="overlay-editor" id="overlay">
        <div style="max-width: 450px; margin: 0 auto;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="input-box"><label>ពណ៌</label><select id="inTheme" onchange="autoSave()"><option value="theme-navy">Navy & Gold</option><option value="theme-red">Royal Red</option></select></div>
                <div class="input-box"><label>ស៊ុម</label><select id="inFrame"><option value="f-classic">Classic Royal</option></select></div>
            </div>
            <div class="input-box"><label>ចំណងជើងធំ</label><input type="text" id="inTitle" oninput="autoSave()"></div>
            <div class="input-box"><label>ឈ្មោះសិស្ស</label><input type="text" id="inName" placeholder="ឈ្មោះសិស្ស..." oninput="autoSave()"></div>
            <div class="input-box"><label>ខ្លឹមសារ</label><textarea id="inDesc" rows="2" oninput="autoSave()"></textarea></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="input-box"><label>ឈ្មោះប្រធាន (ឆ្វេង)</label><input type="text" id="inMan" oninput="autoSave()"></div>
                <div class="input-box"><label>ថ្ងៃខែ (ស្តាំ)</label><input type="text" id="inDate" oninput="autoSave()"></div>
            </div>
            <button class="btn-action" onclick="addNewCert()">+ បង្កើតវិញ្ញាបនប័ត្រថ្មី</button>
            <button id="dlBtn" class="btn-action" style="background:var(--gold); color:#000; border:none;" onclick="downloadAll()">ទាញយក (HD .PNG)</button>
            <button class="btn-action" style="background:#eee; color:#333; border:none;" onclick="toggleMenu()">បិទ</button>
        </div>
    </div>

    <div class="preview-area" id="certList"></div>

    <script>
        function toggleMenu() { document.getElementById('overlay').classList.toggle('active'); }

        function autoSave() {
            const data = {
                theme: document.getElementById('inTheme').value,
                title: document.getElementById('inTitle').value,
                name: document.getElementById('inName').value,
                desc: document.getElementById('inDesc').value,
                man: document.getElementById('inMan').value,
                date: document.getElementById('inDate').value
            };
            localStorage.setItem('cert_save_side', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('cert_save_side');
            if (saved) {
                const d = JSON.parse(saved);
                document.getElementById('inTheme').value = d.theme;
                document.getElementById('inTitle').value = d.title;
                document.getElementById('inName').value = d.name;
                document.getElementById('inDesc').value = d.desc;
                document.getElementById('inMan').value = d.man;
                document.getElementById('inDate').value = d.date;
            } else {
                document.getElementById('inTitle').value = "CERTIFICATE";
                document.getElementById('inDesc').value = "សម្រាប់ការបញ្ចប់វគ្គសិក្សា \"ការរចនាគេហទំព័រ\" ដោយជោគជ័យ។";
                document.getElementById('inMan').value = "លោក ហ៊ាង សុភ័ក្ត្រ";
                document.getElementById('inDate').value = "ថ្ងៃទី ០៦ ខែកុម្ភៈ ឆ្នាំ២០២៦";
            }
        }

        function addNewCert() {
            const theme = document.getElementById('inTheme').value;
            const title = document.getElementById('inTitle').value;
            const name = document.getElementById('inName').value || "ឈ្មោះសិស្ស";
            const desc = document.getElementById('inDesc').value;
            const man = document.getElementById('inMan').value;
            const date = document.getElementById('inDate').value;

            const html = `
                <div class="cert-wrapper ${theme} f-classic">
                    <div class="cert-paper" data-name="${name}">
                        <div class="cert-content">
                            <div class="inner-border"></div>
                            <img src="https://cdn-icons-png.flaticon.com/512/610/610333.png" class="seal">
                            
                            <div style="text-align:center;">
                                <h1 class="cert-title">${title}</h1>
                                <div class="deco-txt">OF EXCELLENCE</div>
                            </div>

                            <div style="text-align:center;">
                                <p style="font-size:26px; color:#555; margin:0; font-style: italic;">វិញ្ញាបនប័ត្រនេះផ្ដល់ជូនចំពោះ</p>
                                <div class="outName" style="font-size:${name.length > 20 ? '60px' : '95px'};">${name}</div>
                            </div>

                            <div style="font-size:24px; color:#333; max-width:850px; text-align:center; line-height:1.6; font-family:'Siemreap';">${desc}</div>

                            <div class="footer">
                                <div class="sign-block">
                                    <div style="font-weight:bold; font-size:28px; color:var(--p);">${man}</div>
                                    <div class="line"></div>
                                    <div style="font-size:14px; color:#888; margin-top:5px; letter-spacing:1px;">SIGNATURE</div>
                                </div>
                                <div class="sign-block">
                                    <div style="font-weight:bold; font-size:24px; color:var(--p);">${date}</div>
                                    <div class="line"></div>
                                    <div style="font-size:14px; color:#888; margin-top:5px; letter-spacing:1px;">DATE</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            document.getElementById('certList').insertAdjacentHTML('beforeend', html);
            if(document.getElementById('overlay').classList.contains('active')) toggleMenu();
        }

        window.onload = () => { loadData(); addNewCert(); };

        async function downloadAll() {
            const certs = document.querySelectorAll('.cert-paper');
            if (certs.length === 0) return;
            
            const btn = document.getElementById('dlBtn');
            btn.innerText = "⏳ កំពុងរង់ចាំ Font និងបង្កើតរូបភាព...";
            btn.disabled = true;

            try {
                // រង់ចាំ Font ឱ្យស្គាល់អស់សិន
                await document.fonts.ready;
                
                // បន្ថែម delay បន្តិចដើម្បីឱ្យ browser render អក្សរបានច្បាស់
                await new Promise(resolve => setTimeout(resolve, 800));

                for (let c of certs) {
                    const canvas = await html2canvas(c, { 
                        scale: 3, 
                        useCORS: true,
                        logging: false,
                        letterRendering: true,
                        allowTaint: false
                    });
                    const link = document.createElement('a');
                    link.download = `${c.getAttribute('data-name')}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                }
            } catch (e) {
                alert("Error generating image.");
            } finally {
                btn.innerText = "ទាញយក (HD .PNG)";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
